# Copyright (c) 2025 Eclipse Foundation.
# 
# This program and the accompanying materials are made available under the
# terms of the MIT License which is available at
# https://opensource.org/licenses/MIT.
#
# SPDX-License-Identifier: MIT

name: Manage Package Tags

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Select tag management action'
        required: true
        default: 'create-release'
        type: choice
        options:
        - 'create-release'
        - 'retag-existing' 
        - 'promote-to-latest'
        - 'create-prerelease'
        - 'list-tags'
      version:
        description: 'Version tag (e.g., v2.1.0, v2.1.0-beta.1)'
        required: false
        type: string
      source_tag:
        description: 'Source tag (for retag/promote operations)'
        required: false
        type: string
      target_tag:
        description: 'Target tag (for retag operations)'
        required: false
        type: string
      release_notes:
        description: 'Release notes (optional)'
        required: false
        type: string

jobs:
  manage-tags:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      attestations: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Set up QEMU
        if: inputs.action == 'create-release' || inputs.action == 'create-prerelease'
        uses: docker/setup-qemu-action@v3

      - name: Setup Docker Buildx
        if: inputs.action == 'create-release' || inputs.action == 'create-prerelease'
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate inputs
        run: |
          case "${{ inputs.action }}" in
            "create-release"|"create-prerelease")
              if [ -z "${{ inputs.version }}" ]; then
                echo "Error: version is required for ${{ inputs.action }}"
                exit 1
              fi
              ;;
            "retag-existing")
              if [ -z "${{ inputs.source_tag }}" ] || [ -z "${{ inputs.target_tag }}" ]; then
                echo "Error: both source_tag and target_tag are required for retag-existing"
                exit 1
              fi
              ;;
            "promote-to-latest")
              if [ -z "${{ inputs.source_tag }}" ]; then
                echo "Error: source_tag is required for promote-to-latest"
                exit 1
              fi
              ;;
          esac

      - name: List existing tags
        if: inputs.action == 'list-tags'
        run: |
          echo "### üìã Existing Tags:"
          git tag -l | sort -V | tail -20
          echo ""
          echo "### üê≥ Available Container Images:"
          echo "Latest 10 container tags:"
          # Note: This would require GitHub API call to list actual container registry tags
          echo "Check: https://github.com/${{ github.repository }}/pkgs/container/sdv-runtime"

      - name: Create new release tag and build
        if: inputs.action == 'create-release'
        run: |
          echo "Creating release tag: ${{ inputs.version }}"
          
          # Validate version format
          if ! echo "${{ inputs.version }}" | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "Error: Version must follow semantic versioning (e.g., v2.1.0)"
            exit 1
          fi
          
          # Check if tag already exists
          if git tag -l | grep -q "^${{ inputs.version }}$"; then
            echo "Error: Tag ${{ inputs.version }} already exists"
            exit 1
          fi
          
          # Create and push tag
          git tag -a "${{ inputs.version }}" -m "Release ${{ inputs.version }}"
          git push origin "${{ inputs.version }}"
          
          echo "‚úÖ Created and pushed tag: ${{ inputs.version }}"
          echo "üöÄ Release workflow will start automatically to build containers"

      - name: Create new prerelease tag and build
        if: inputs.action == 'create-prerelease'
        run: |
          echo "Creating prerelease tag: ${{ inputs.version }}"
          
          # Validate prerelease version format
          if ! echo "${{ inputs.version }}" | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+-(alpha|beta|rc)\.[0-9]+$'; then
            echo "Error: Prerelease version must follow format (e.g., v2.1.0-beta.1)"
            exit 1
          fi
          
          # Check if tag already exists
          if git tag -l | grep -q "^${{ inputs.version }}$"; then
            echo "Error: Tag ${{ inputs.version }} already exists"
            exit 1
          fi
          
          # Create and push tag
          git tag -a "${{ inputs.version }}" -m "Prerelease ${{ inputs.version }}"
          git push origin "${{ inputs.version }}"
          
          echo "‚úÖ Created and pushed prerelease tag: ${{ inputs.version }}"
          echo "üöÄ Release workflow will start automatically to build containers"

      - name: Retag existing container image
        if: inputs.action == 'retag-existing'
        run: |
          echo "Retagging container from ${{ inputs.source_tag }} to ${{ inputs.target_tag }}"
          
          # Check if source tag exists in registry
          if ! docker pull ghcr.io/${{ github.repository_owner }}/sdv-runtime:${{ inputs.source_tag }}; then
            echo "Error: Source tag ${{ inputs.source_tag }} not found in container registry"
            exit 1
          fi
          
          # Retag and push
          docker tag ghcr.io/${{ github.repository_owner }}/sdv-runtime:${{ inputs.source_tag }} \
                     ghcr.io/${{ github.repository_owner }}/sdv-runtime:${{ inputs.target_tag }}
          
          docker push ghcr.io/${{ github.repository_owner }}/sdv-runtime:${{ inputs.target_tag }}
          
          echo "‚úÖ Successfully retagged container:"
          echo "   From: ghcr.io/${{ github.repository_owner }}/sdv-runtime:${{ inputs.source_tag }}"
          echo "   To:   ghcr.io/${{ github.repository_owner }}/sdv-runtime:${{ inputs.target_tag }}"

      - name: Promote tag to latest
        if: inputs.action == 'promote-to-latest'
        run: |
          echo "Promoting ${{ inputs.source_tag }} to latest"
          
          # Check if source tag exists in registry
          if ! docker pull ghcr.io/${{ github.repository_owner }}/sdv-runtime:${{ inputs.source_tag }}; then
            echo "Error: Source tag ${{ inputs.source_tag }} not found in container registry"
            exit 1
          fi
          
          # Tag as latest and push
          docker tag ghcr.io/${{ github.repository_owner }}/sdv-runtime:${{ inputs.source_tag }} \
                     ghcr.io/${{ github.repository_owner }}/sdv-runtime:latest
          
          docker push ghcr.io/${{ github.repository_owner }}/sdv-runtime:latest
          
          echo "‚úÖ Successfully promoted to latest:"
          echo "   Source: ghcr.io/${{ github.repository_owner }}/sdv-runtime:${{ inputs.source_tag }}"
          echo "   Latest: ghcr.io/${{ github.repository_owner }}/sdv-runtime:latest"

      - name: Create GitHub Release
        if: inputs.action == 'create-release' || inputs.action == 'create-prerelease'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ inputs.version }}
          release_name: Release ${{ inputs.version }}
          body: |
            ${{ inputs.release_notes || 'Automated release created via workflow' }}
            
            ## üì¶ Container Images
            
            - `ghcr.io/${{ github.repository_owner }}/sdv-runtime:${{ inputs.version }}`
            - Multi-platform support: `linux/amd64`, `linux/arm64`
            
            ## üöÄ Usage
            
            ```bash
            docker pull ghcr.io/${{ github.repository_owner }}/sdv-runtime:${{ inputs.version }}
            ```
          draft: false
          prerelease: ${{ inputs.action == 'create-prerelease' }}

      - name: Summary
        run: |
          echo "### üéØ Tag Management Complete!"
          echo ""
          echo "**Action Performed:** ${{ inputs.action }}"
          case "${{ inputs.action }}" in
            "create-release"|"create-prerelease")
              echo "**New Tag Created:** ${{ inputs.version }}"
              echo "**Container Image:** ghcr.io/${{ github.repository_owner }}/sdv-runtime:${{ inputs.version }}"
              echo "**GitHub Release:** Created automatically"
              ;;
            "retag-existing")
              echo "**Retagged From:** ${{ inputs.source_tag }}"
              echo "**Retagged To:** ${{ inputs.target_tag }}"
              ;;
            "promote-to-latest")
              echo "**Promoted:** ${{ inputs.source_tag }} ‚Üí latest"
              ;;
            "list-tags")
              echo "**Action:** Listed existing tags and container images"
              ;;
          esac
          echo ""
          echo "‚úÖ Operation completed successfully!"